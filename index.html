<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Whale-LLT 小手机</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="AI聊天助手">
    <meta name="theme-color" content="#07c160">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Whale-LLT">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Whale-LLT">
    
    <!-- PWA Icons -->
    <link rel="apple-touch-icon" sizes="152x152" href="icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="icons/icon-180x180.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/icon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/icon-16x16.png">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#07c160">
    <meta name="msapplication-TileColor" content="#07c160">
    
    <!-- Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <link rel="stylesheet" href="style.css">
    
    <!-- 字体按需加载 - 移除预加载的CSS，改为动态加载 -->
    
    <script src="config/sync-config.js"></script>
    <script src="config/environment-config.js"></script>
    <script src="js/environment-indicator.js"></script>
    <script src="utils/apiConfigManager.js"></script>
    <script src="utils/modelCapabilityDetector.js"></script>
    <script src="utils/fontLoader.js"></script>

    <!-- Analytics -->
    <script defer src="https://umami.whale-llt.top/script.js" data-website-id="00c95749-7c0d-4333-9ec1-2ad2701799a3"></script>

</head>
<body>
    <!-- 页面主体内容保持不变 -->
    <div class="main-container">
        <div class="contact-list-page active" id="contactListPage">
            <div class="wechat-header">
                <div class="header-title">Whale-LLT</div>
                <div class="header-actions">
                    <span class="header-icon" id="apiSettingsIcon">⚙️</span>
                    <span class="header-icon" id="musicIcon" onclick="showMusicModal()" data-umami-event="Music Open">🎵</span>
                    <span class="header-icon" onclick="showAddContactModal()" data-umami-event="Add Contact Open">➕</span>
                    <span class="header-icon" onclick="showCreateGroupModal()" data-umami-event="Create Group Open">👥</span>
                </div>
            </div>
            
            <div class="search-bar">
                <input type="text" class="search-input" placeholder="搜索">
            </div>
            
            <div id="contactList"></div>
        </div>

        <div class="chat-page" id="chatPage">
            <div class="chat-header">
                <div class="back-btn" onclick="showPage('contactListPage')">
                    <span>‹</span>
                    <span>Whale-LLT</span>
                </div>
                <div class="chat-title" id="chatTitle">聊天</div>
                <div class="chat-header-actions">
                    <div class="memory-btn" onclick="event.stopPropagation(); toggleMemoryPanel()">
                        <svg t="1689237694389" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4338" width="24" height="24"><path d="M896 96H128C110.4 96 96 110.4 96 128v768c0 17.6 14.4 32 32 32h768c17.6 0 32-14.4 32-32V128c0-17.6-14.4-32-32-32zM384 832H192v-64h192v64z m0-192H192v-64h192v64z m0-192H192v-64h192v64z m448 384H448v-64h384v64z m0-192H448v-64h384v64z m0-192H448v-64h384v64z" p-id="4339" fill="#515151"></path></svg>
                    </div>
                    <div class="chat-more" onclick="openContactSettingsPage()">⋯</div>
                </div>
            </div>
            
            <div class="chat-messages" id="chatMessages">
                <div class="messages-scroll-content"></div>
            </div>
            
            <div class="chat-input-area">
                <div class="feature-hint" id="featureHint">按Enter发送消息，点"发送"按钮获取AI回复</div>
                <div class="input-actions">
                    <div class="action-btn" onclick="toggleEmojiPanel()" data-umami-event="Emoji Panel Toggle">😊</div>
                    <div class="action-btn" onclick="showRedPacketModal()" data-umami-event="Red Packet Open">🧧</div>
                    <div class="action-btn" onclick="triggerImageUpload()" data-umami-event="Image Upload Open">🏞️</div>
                </div>
                
                <!-- 隐藏的文件输入框 -->
                <input type="file" id="chatImageInput" accept="image/*" style="display: none;" onchange="handleChatImageUpload(event)">
                <textarea class="chat-input" id="chatInput" placeholder="输入消息" rows="1"></textarea>
                <button class="send-btn" id="sendBtn" onclick="sendMessage()" data-umami-event="Message Send">发送</button>
                
                <div class="emoji-panel" id="emojiPanel">
                    <div class="emoji-grid" id="emojiGrid">
                        <div class="add-emoji-btn" onclick="showAddEmojiModal()">+ 添加表情</div>
                    </div>
                </div>
            </div>

            <div class="memory-panel" id="memoryPanel">
                <div class="memory-panel-header">
                    <div class="memory-panel-title">记忆表格</div>
                    <div class="memory-panel-actions">
                         <button id="memoryEditBtn" class="memory-panel-btn" onclick="toggleMemoryEditMode()" data-umami-event="Memory Table Edit Toggle">编辑</button>
                         <button class="memory-panel-btn" onclick="event.stopPropagation(); toggleMemoryPanel()">关闭</button>
                    </div>
                </div>
                <div class="memory-panel-content">
                    <div id="memoryTableView" class="memory-table-view"></div>
                    <textarea id="memoryTextarea" class="memory-textarea" style="display: none;"></textarea>
                </div>
            </div>
        </div>

        <div class="moments-page" id="momentsPage">
            <div class="moments-header">
                <div class="back-btn" onclick="showPage('contactListPage')">
                    <span>‹</span>
                    <span>返回</span>
                </div>
                <div class="chat-title">朋友圈</div>
                <div class="chat-more" onclick="showPublishMomentModal()">➕</div>
            </div>
            
            <div class="moments-content" id="momentsContent">
                <div class="moments-empty" id="momentsEmpty">
                    <div class="moments-empty-icon">📝</div>
                    <div class="moments-empty-text">还没有朋友圈动态</div>
                    <button class="moments-empty-btn" onclick="showPublishMomentModal()">发布第一条动态</button>
                </div>
                
                <div class="moments-list" id="momentsList" style="display: none;"></div>
            </div>
        </div>

        <div class="interactive-page" id="interactivePage">
            <div class="chat-header">
                <div class="back-btn" onclick="showPage('contactListPage')">
                    <span>‹</span>
                    <span>互动界面</span>
                </div>
                <div class="header-actions">
                    <div class="sync-btn" onclick="syncInteractiveData()" title="同步角色数据">🔄</div>
                </div>
            </div>
            <div class="interactive-content">
                <iframe id="interactiveFrame" src="interact.html" style="width: 100%; height: calc(100vh - 60px); border: none;"></iframe>
            </div>
        </div>

        <!-- 隐藏的气泡设计器iframe，用于单文件模式 -->
        <iframe id="bubbleDesignerFrame" src="bubble.html" style="display: none;"></iframe>

        <div style="display: none;" id="hiddenContainer">
        </div>

        <div class="profile-page" id="profilePage">
            <div class="chat-header">
                <div class="back-btn" onclick="showPage('contactListPage')">
                    <span>‹</span>
                    <span>Whale-LLT</span>
                </div>
                <div class="chat-title">个人信息</div>
                <div class="chat-header-spacer"></div>
            </div>
            
            <div class="profile-header">
                <div class="profile-avatar" id="userAvatar">我</div>
                <div class="profile-name" id="userName">我的昵称</div>
                <div class="profile-id">id号：AI_User_001</div>
            </div>
            
            <div class="profile-section">
                <div class="profile-item" onclick="showEditProfileModal()" data-umami-event="Edit Profile Open">
                    <div class="profile-item-label">编辑个人信息</div>
                    <div class="profile-item-arrow">›</div>
                </div>
                <div class="profile-item" onclick="showUserProfile()">
                    <div class="profile-item-label">我的个人主页</div>
                    <div class="profile-item-arrow">›</div>
                </div>
                <div class="profile-item" onclick="showPage('appearanceManagementPage')" data-umami-event="Appearance Management Open">
                    <div class="profile-item-label">外观管理</div>
                    <div class="profile-item-arrow">›</div>
                </div>
                <div class="profile-item" onclick="showPage('dataManagementPage')" data-umami-event="Data Management Open">
                    <div class="profile-item-label">数据管理</div>
                    <div class="profile-item-arrow">›</div>
                </div>
                <div class="profile-item" onclick="showPage('memoryManagementPage')" data-umami-event="Memory Management Open">
                    <div class="profile-item-label">记忆管理</div>
                    <div class="profile-item-arrow">›</div>
                </div>
                <div class="profile-item" onclick="window.SystemUtils.showDebugLogPage()"
                data-umami-event="Debug Log Open">
                    <div class="profile-item-label">查看调试日志</div>
                    <div class="profile-item-arrow">›</div>
                </div>
                
                <!-- 版本号显示 -->
                <div class="profile-version" id="profileVersion">
                    <span id="profileVersionText">-</span>
                </div>
            </div>
        </div>

        <div class="weibo-page" id="weiboPage">
            <div class="weibo-header">
                <div class="back-btn" onclick="showPage('contactListPage')">
                    <span>‹</span>
                    <span>返回</span>
                </div>
                <div class="chat-title">论坛</div>
                <div class="chat-more" onclick="showPostChoiceModal()">➕</div>
            </div>
            <div class="weibo-container" id="weiboContainer">
                <div class="weibo-scroll-content"></div>
            </div>
        </div>

        <div class="data-management-page" id="dataManagementPage">
            <div class="chat-header">
                <div class="back-btn" onclick="showPage('profilePage')">
                    <span>‹</span>
                    <span>返回</span>
                </div>
                <div class="chat-title">数据管理</div>
                <div class="chat-header-spacer"></div>
            </div>
            
            <div class="data-management-container">
                <!-- 数据统计信息 -->
                <div class="database-stats" style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin: 15px; margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h3 style="margin: 0; font-size: 18px; font-weight: bold; color: #333;">数据统计</h3>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div id="persistentStatusIndicator" style="font-size: 13px; font-weight: bold;">
                                ⏳ 检查中...
                            </div>
                            <button type="button" class="info-button" 
                                    onclick="StorageManager.showPersistentStorageInfo()" 
                                    title="点击查看持久化存储说明">
                                ?
                            </button>
                        </div>
                    </div>
                    <div id="databaseStatsContent" style="font-size: 13px; color: #666;">
                        <div>正在加载统计信息...</div>
                    </div>
                    <div style="display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap;">
                        <button type="button" class="refresh-stats-btn" onclick="refreshDatabaseStats()" 
                                style="padding: 5px 10px; font-size: 12px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            刷新统计
                        </button>
                        <button type="button" class="request-persistent-btn" 
                                onclick="StorageManager.requestPersistentStorageAndRefresh()" 
                                title="申请将数据库设为持久化存储，防止被浏览器清理">
                            💾 申请持久化数据库
                        </button>
                        <button type="button" class="optimize-db-btn" onclick="optimizeEmojiDatabase()" 
                                style="padding: 5px 10px; font-size: 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;" title="将Base64表情转换为标签格式，减小数据库体积">
                            🚀 数据库优化
                        </button>
                        <button type="button" class="clear-localStorage-btn" onclick="showClearLocalStorageConfirmation()" 
                                style="padding: 5px 10px; font-size: 12px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;" title="清空浏览器本地存储，谨慎操作">
                            🗑️ 清空LocalStorage
                        </button>
                    </div>
                </div>

                
                <!-- 导入导出操作 -->
                <div class="import-export-actions" style="margin: 15px;">
                    <!-- 导入说明 -->
                    <div class="import-warning" style="margin-top: 10px; padding: 10px; background: #f8d7da; border-radius: 4px; border: 1px solid #f5c6cb;">
                        <div style="font-size: 13px; color: #721c24; margin-bottom: 5px;">
                            <strong>⚠️ 重要提醒</strong>
                        </div>
                        <div style="font-size: 12px; color: #721c24;">
                            导入数据将完全覆盖现有的所有数据！请确保已备份重要信息！！
                        </div>
                    </div>
                    <!-- 数据库导入导出 -->
                    <div style="margin-bottom: 15px; padding: 15px; background: #e8f5e8; border: 1px solid #4caf50; border-radius: 4px;">
                        <div style="margin-bottom: 10px; font-size: 14px; font-weight: bold; color: #2e7d32;">
                            💾 数据库完整备份
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button type="button" class="form-submit" onclick="exportDatabase()" data-umami-event="Export Database"
                                    style="flex: 1; background-color: #28a745;">
                                📤 导出数据库
                            </button>
                            <button type="button" class="form-submit" onclick="triggerFileSelect()" data-umami-event="Import Database"
                                    style="flex: 1; background-color: #dc3545;">
                                📥 导入数据库
                            </button>
                        </div>
                    </div>

                    <!-- 文件存储导入导出 -->
                    <div style="margin-bottom: 15px; padding: 15px; background: #fff3e0; border: 1px solid #ff9800; border-radius: 4px;">
                        <div style="margin-bottom: 10px; font-size: 14px; font-weight: bold; color: #ef6c00;">
                            🖼️ 文件存储迁移（图片、表情包、背景）
                        </div>
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <button type="button" class="form-submit" onclick="exportFileStorage()" data-umami-event="Export Media Files"
                                    style="flex: 1; background-color: #ff9800;">
                                📤 导出文件
                            </button>
                            <button type="button" class="form-submit" onclick="triggerFileStorageImport()" data-umami-event="Import Media Files"
                                    style="flex: 1; background-color: #f57c00;">
                                📥 导入文件
                            </button>
                        </div>
                        <div style="font-size: 12px; color: #bf360c; margin-bottom: 10px;">
                            导出为ZIP格式，保持原始文件格式（jpg/png/gif等），在新环境中导入时会自动匹配对应项目
                        </div>
                        
                        <!-- 文件存储导出选项 -->
                        <div id="fileExportOptions" style="display: none; margin-top: 10px; padding: 10px; background: #fff; border: 1px solid #ddd; border-radius: 4px;">
                            <div style="font-size: 13px; font-weight: bold; margin-bottom: 8px; color: #333;">选择要导出的文件类型：</div>
                            <label style="display: block; margin-bottom: 5px; font-size: 12px;">
                                <input type="checkbox" id="exportAvatars" checked style="margin-right: 5px;">
                                头像图片（联系人和用户头像）
                            </label>
                            <label style="display: block; margin-bottom: 5px; font-size: 12px;">
                                <input type="checkbox" id="exportBackgrounds" checked style="margin-right: 5px;">
                                聊天背景图片
                            </label>
                            <label style="display: block; margin-bottom: 5px; font-size: 12px;">
                                <input type="checkbox" id="exportEmojis" checked style="margin-right: 5px;">
                                表情包图片
                            </label>
                            <label style="display: block; margin-bottom: 10px; font-size: 12px;">
                                <input type="checkbox" id="exportMoments" checked style="margin-right: 5px;">
                                朋友圈图片
                            </label>
                            <div style="display: flex; gap: 10px;">
                                <button type="button" class="form-submit" onclick="confirmFileExport()" data-umami-event="Confirm File Export"
                                        style="flex: 1; background-color: #4caf50; font-size: 12px; padding: 6px;">
                                    ✅ 确认导出
                                </button>
                                <button type="button" class="form-submit" onclick="cancelFileExport()" data-umami-event="Cancel File Export"
                                        style="flex: 1; background-color: #f44336; font-size: 12px; padding: 6px;">
                                    ❌ 取消
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 其他功能 -->
                    <div style="margin-bottom: 15px;">
                        <button type="button" class="form-submit" id="shareDataBtn" onclick="handleShareData()" data-umami-event="Transfer Data" 
                                style="width: 100%; background-color: #007bff;">
                            🔗 数据传输
                        </button>
                    </div>

                    <!-- 云同步功能 -->
                    <div style="margin-bottom: 15px; padding: 15px; background: #e3f2fd; border: 1px solid #90caf9; border-radius: 4px;">
                        <div style="margin-bottom: 10px; font-size: 14px; font-weight: bold; color: #1565c0;">
                            🌐 云端数据同步
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <button type="button" class="form-submit" onclick="uploadDataToCloud()" 
                                    style="flex: 1; background-color: #4caf50;">
                                ☁️ 上传到云端
                            </button>
                            <button type="button" class="form-submit" onclick="downloadDataFromCloud()" 
                                    style="flex: 1; background-color: #2196f3;">
                                ⬇️ 从云端下载
                            </button>
                        </div>
                        
                        <div style="margin-bottom: 10px;">
                            <input type="text" id="syncKeyInput" placeholder="输入同步标识符" 
                                   style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                        </div>
                        
                        <div id="syncStatus" style="font-size: 12px; color: #666; text-align: center;"></div>
                    </div>
                    
                    
                    <input type="file" id="importFileInput" accept=".json" style="display: none;" onchange="handleFileSelect(event)">
                    <input type="file" id="fileStorageImportInput" accept=".zip,.json" style="display: none;" onchange="handleFileStorageImport(event)">
                </div>

                <!-- 数据优化功能 -->
                <div class="data-optimization-section" style="margin: 15px;">
                    <!-- 图片存储优化部分 -->
                    <div class="context-control" style="margin-bottom: 15px; padding: 15px; border: 1px solid #e0e0e0; border-radius: 8px; background-color: #f9f9f9;">
                        <div class="context-header">
                            <div class="context-title" style="color: #333; font-weight: bold;">📁 图片存储优化</div>
                            <div class="context-value" id="migrationStatusText">检查中...</div>
                        </div>
                        <div class="context-info" style="margin-top: 10px; font-size: 13px; color: #666;">
                            将现有的base64图片数据转换为高效的文件存储格式，可显著减少存储空间占用并提升性能。
                        </div>
                        
                        <!-- 迁移状态显示 -->
                        <div id="migrationStatusDetails" style="margin-top: 10px; padding: 10px; background: white; border-radius: 4px; border: 1px solid #ddd; font-size: 12px; color: #666;">
                            <div>正在检查图片数据状态...</div>
                        </div>

                        <!-- 迁移按钮组 -->
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <button type="button" class="form-submit" onclick="checkImageMigrationStatus()" style="flex: 1; font-size: 12px;">
                                🔍 检查状态
                            </button>
                            <button type="button" class="form-submit" id="startMigrationBtn" onclick="startImageMigration()" 
                                    style="flex: 2; font-size: 12px; background-color: #ff9500;" disabled>
                                🚀 开始优化
                            </button>
                        </div>

                        <!-- 迁移进度显示 -->
                        <div id="migrationProgress" style="margin-top: 10px; display: none;">
                            <div style="background: #f0f0f0; border-radius: 4px; overflow: hidden; height: 8px; margin-bottom: 5px;">
                                <div id="migrationProgressBar" style="background: #07c160; height: 100%; width: 0%; transition: width 0.3s;"></div>
                            </div>
                            <div id="migrationProgressText" style="font-size: 11px; color: #666;">准备开始...</div>
                        </div>
                    </div>

                    <!-- 聊天记录表情包优化部分 -->
                    <div class="context-control" style="margin-bottom: 15px; padding: 15px; border: 1px solid #e0e0e0; border-radius: 8px; background-color: #f0f8ff;">
                        <div class="context-header">
                            <div class="context-title" style="color: #333; font-weight: bold;">💬 聊天记录表情优化</div>
                            <div class="context-value" id="chatEmojiMigrationStatusText">检查中...</div>
                        </div>
                        <div class="context-info" style="margin-top: 10px; font-size: 13px; color: #666;">
                            优化聊天记录中的表情包存储格式，将base64格式转换为高效的文件存储，同时保持API兼容性。
                        </div>
                        
                        <!-- 迁移状态显示 -->
                        <div id="chatEmojiMigrationStatusDetails" style="margin-top: 10px; padding: 10px; background: white; border-radius: 4px; border: 1px solid #ddd; font-size: 12px; color: #666;">
                            <div>正在检查聊天记录中的表情包状态...</div>
                        </div>

                        <!-- 迁移按钮组 -->
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <button type="button" class="form-submit" onclick="checkChatEmojiMigrationStatus()" style="flex: 1; font-size: 12px;">
                                🔍 检查状态
                            </button>
                            <button type="button" class="form-submit" id="startChatEmojiMigrationBtn" onclick="startChatEmojiMigration()" 
                                    style="flex: 2; font-size: 12px; background-color: #1890ff;" disabled>
                                💬 开始优化
                            </button>
                        </div>

                        <!-- 迁移进度显示 -->
                        <div id="chatEmojiMigrationProgress" style="margin-top: 10px; display: none;">
                            <div style="background: #f0f0f0; border-radius: 4px; overflow: hidden; height: 8px; margin-bottom: 5px;">
                                <div id="chatEmojiMigrationProgressBar" style="background: #1890ff; height: 100%; width: 0%; transition: width 0.3s;"></div>
                            </div>
                            <div id="chatEmojiMigrationProgressText" style="font-size: 11px; color: #666;">准备开始...</div>
                        </div>
                    </div>

                    <!-- Unsplash -->
                    <div class="context-control" style="margin-bottom: 15px; padding: 15px; border: 1px solid #e0e0e0; border-radius: 8px; background-color: #f5f8ff;">
                        <div class="context-header">
                            <div class="context-title" style="color: #333; font-weight: bold;">🎨 文字配图</div>
                            <div class="context-value" id="imageKeywordStatusText">
                                <span id="imageKeywordStatus"></span>
                            </div>
                        </div>
                        <div class="context-info" style="margin-top: 10px; font-size: 13px; color: #666;">
                            使用 Unsplash API 为论坛或朋友圈配图
                        </div>
                        
                        <!-- 配置状态显示 -->
                        <div id="imageKeywordConfigStatus" style="margin-top: 10px; padding: 10px; background: white; border-radius: 4px; border: 1px solid #ddd; font-size: 12px; color: #666;">
                            <div>正在检查配置状态...</div>
                        </div>

                        <!-- 控制按钮 -->
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <button type="button" class="form-submit" onclick="checkImageKeywordStatus()" style="flex: 1; font-size: 12px;">
                                🔍 检查状态
                            </button>
                            <button type="button" class="form-submit" onclick="openImageKeywordSettings()" style="flex: 1; font-size: 12px; background-color: #28a745;">
                                ⚙️ 配置设置
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="debug-log-page" id="debugLogPage">
            <div class="chat-header">
                <div class="back-btn" onclick="showPage('profilePage')">
                    <span>‹</span>
                    <span>返回</span>
                </div>
                <div class="chat-title">调试日志</div>
                <div class="header-actions">
                    <button class="header-btn" onclick="window.SystemUtils.clearDebugLogs()">清空</button>
                    <button class="header-btn" onclick="window.SystemUtils.copyDebugLogs()">复制</button>
                </div>
            </div>
            
            <div class="debug-log-container">
                <div class="debug-log-info">
                    <div class="debug-log-stats">
                        总计 <span id="logCount">0</span> 条日志
                    </div>
                    <div class="debug-log-hint">
                        显示浏览器控制台的实时日志，包括错误、警告和调试信息
                    </div>
                </div>
                
                <div class="debug-log-content" id="debugLogContent">
                    <div class="debug-log-empty">
                        暂无日志记录
                    </div>
                </div>
            </div>
        </div>

        <!-- 外观管理页面 -->
        <div class="appearance-management-page" id="appearanceManagementPage">
            <div class="chat-header">
                <div class="back-btn" onclick="showPage('profilePage')">
                    <span>‹</span>
                </div>
                <div class="chat-title">外观管理</div>
            </div>
            
            <div class="appearance-content">
                <!-- 暗黑模式选择 -->
                <div class="appearance-section">
                    <h3 class="appearance-section-title">主题模式</h3>
                    <p class="appearance-section-desc">选择你喜欢的主题模式，支持跟随系统设置</p>
                    
                    <div class="theme-mode-grid">
                        <div class="theme-mode-option active" data-theme="system" onclick="window.UIManager.switchTheme('system')">
                            <div class="theme-mode-icon">🔄</div>
                            <div class="theme-mode-content">
                                <div class="theme-mode-name">跟随系统</div>
                                <div class="theme-mode-desc">自动跟随系统暗色模式</div>
                            </div>
                        </div>
                        <div class="theme-mode-option" data-theme="light" onclick="window.UIManager.switchTheme('light')">
                            <div class="theme-mode-icon">☀️</div>
                            <div class="theme-mode-content">
                                <div class="theme-mode-name">亮色模式</div>
                                <div class="theme-mode-desc">始终使用亮色主题</div>
                            </div>
                        </div>
                        <div class="theme-mode-option" data-theme="dark" onclick="window.UIManager.switchTheme('dark')">
                            <div class="theme-mode-icon">🌙</div>
                            <div class="theme-mode-content">
                                <div class="theme-mode-name">暗黑模式</div>
                                <div class="theme-mode-desc">始终使用暗色主题</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 主题色选择 -->
                <div class="appearance-section">
                    <h3 class="appearance-section-title">主题色彩</h3>
                    <p class="appearance-section-desc">选择你喜欢的主题色，个性化你的应用界面</p>
                    
                    <div class="theme-color-grid">
                        <!-- 默认绿色 -->
                        <div class="theme-color-option active" data-color="#07c160" data-name="鲜绿">
                            <div class="theme-color-preview" style="background-color: #07c160;"></div>
                            <div class="theme-color-name">鲜绿</div>
                        </div>
                        <!-- 蓝色 -->
                        <div class="theme-color-option" data-color="#1890ff" data-name="天空蓝">
                            <div class="theme-color-preview" style="background-color: #1890ff;"></div>
                            <div class="theme-color-name">天空蓝</div>
                        </div>
                        <!-- 紫色 -->
                        <div class="theme-color-option" data-color="#722ed1" data-name="深紫">
                            <div class="theme-color-preview" style="background-color: #722ed1;"></div>
                            <div class="theme-color-name">深紫</div>
                        </div>
                        <!-- 红色 -->
                        <div class="theme-color-option" data-color="#f5222d" data-name="火红">
                            <div class="theme-color-preview" style="background-color: #f5222d;"></div>
                            <div class="theme-color-name">火红</div>
                        </div>
                        <!-- 橙色 -->
                        <div class="theme-color-option" data-color="#fa8c16" data-name="橙">
                            <div class="theme-color-preview" style="background-color: #fa8c16;"></div>
                            <div class="theme-color-name">橙</div>
                        </div>
                        <!-- 青色 -->
                        <div class="theme-color-option" data-color="#13c2c2" data-name="清新青">
                            <div class="theme-color-preview" style="background-color: #13c2c2;"></div>
                            <div class="theme-color-name">清新青</div>
                        </div>
                        <!-- 粉色 -->
                        <div class="theme-color-option" data-color="#eb2f96" data-name="亮粉">
                            <div class="theme-color-preview" style="background-color: #eb2f96;"></div>
                            <div class="theme-color-name">亮粉</div>
                        </div>
                        <!-- 深蓝 -->
                        <div class="theme-color-option" data-color="#2f54eb" data-name="海蓝">
                            <div class="theme-color-preview" style="background-color: #2f54eb;"></div>
                            <div class="theme-color-name">海蓝</div>
                        </div>
                    </div>
                    
                    <!-- 自定义颜色选择器 -->
                    <div class="custom-color-section">
                        <label for="customColorPicker" class="custom-color-label">自定义颜色</label>
                        <p class="custom-color-desc">点击颜色圆圈选择，或直接输入十六进制颜色代码</p>
                        
                        <div class="custom-color-preview-row">
                            <div class="custom-color-preview-container">
                                <div class="custom-color-preview-circle" id="customColorPreview" style="background-color: #07c160;">
                                    <input type="color" id="customColorPicker" class="custom-color-picker-hidden" value="#07c160">
                                </div>
                                <span class="custom-color-preview-label">预览</span>
                            </div>
                            
                            <div class="custom-color-input-container">
                                <input type="text" id="customColorText" class="custom-color-text" placeholder="#07c160" maxlength="7">
                                <button type="button" class="apply-custom-color-btn" onclick="applyCustomColor()">应用</button>
                            </div>
                        </div>
                        
                        <div class="color-input-tips">
                            <small>💡 提示：支持格式如 #FF0000、#ff0000 等六位十六进制颜色代码</small>
                        </div>
                    </div>
                </div>
                
                <!-- 渐变主题设置 -->
                <div class="appearance-section">
                    <h3 class="appearance-section-title">渐变主题</h3>
                    <p class="appearance-section-desc">开启渐变效果，让界面更具视觉层次感</p>
                    
                    <div class="gradient-toggle-container">
                        <label class="gradient-toggle-label">
                            <input type="checkbox" id="gradientToggle" class="gradient-toggle-input">
                            <span class="gradient-toggle-slider"></span>
                            启用渐变主题
                        </label>
                    </div>
                    
                    <div class="gradient-settings" id="gradientSettings" style="display: none;">
                        <div class="gradient-color-row">
                            <div class="gradient-color-group">
                                <label class="gradient-color-label">主色</label>
                                <div class="gradient-color-picker-container">
                                    <div class="gradient-color-preview" id="gradientPrimaryPreview" style="background-color: #07c160;">
                                        <input type="color" id="gradientPrimaryPicker" class="gradient-color-picker-hidden" value="#07c160">
                                    </div>
                                    <input type="text" id="gradientPrimaryText" class="gradient-color-text" placeholder="#07c160" maxlength="7" value="#07c160">
                                </div>
                            </div>
                            
                            <div class="gradient-color-group">
                                <label class="gradient-color-label">副色</label>
                                <div class="gradient-color-picker-container">
                                    <div class="gradient-color-preview" id="gradientSecondaryPreview" style="background-color: #1890ff;">
                                        <input type="color" id="gradientSecondaryPicker" class="gradient-color-picker-hidden" value="#1890ff">
                                    </div>
                                    <input type="text" id="gradientSecondaryText" class="gradient-color-text" placeholder="#1890ff" maxlength="7" value="#1890ff">
                                </div>
                            </div>
                        </div>
                        
                        <div class="gradient-preview-container">
                            <label class="gradient-preview-label">效果预览</label>
                            <div class="gradient-preview-demo" id="gradientPreviewDemo">
                                <div class="gradient-preview-text">渐变效果预览</div>
                            </div>
                        </div>
                        
                        <div class="gradient-direction-container">
                            <label class="gradient-direction-label">渐变方向</label>
                            <div class="gradient-direction-options">
                                <label class="gradient-direction-option">
                                    <input type="radio" name="gradientDirection" value="to right" checked>
                                    <span class="gradient-direction-text">→ 水平</span>
                                </label>
                                <label class="gradient-direction-option">
                                    <input type="radio" name="gradientDirection" value="to bottom">
                                    <span class="gradient-direction-text">↓ 垂直</span>
                                </label>
                                <label class="gradient-direction-option">
                                    <input type="radio" name="gradientDirection" value="135deg">
                                    <span class="gradient-direction-text">↘ 对角</span>
                                </label>
                            </div>
                        </div>
                        
                        <button type="button" class="apply-gradient-btn" onclick="applyGradientThemeFromUI()">应用渐变主题</button>
                    </div>
                </div>
                
                <!-- 聊天气泡设计器 -->
                <div class="appearance-section">
                    <h3 class="appearance-section-title">聊天气泡设计</h3>
                    <p class="appearance-section-desc">设计个性化的聊天气泡样式，添加贴图装饰</p>
                    <div class="bubble-designer-option">
                        <button type="button" class="bubble-designer-btn" onclick="openBubbleDesigner()">
                            <div class="bubble-designer-icon">💬</div>
                            <div class="bubble-designer-info">
                                <div class="bubble-designer-title">气泡样式设计器</div>
                                <div class="bubble-designer-desc">自定义气泡颜色、边框、贴图装饰等</div>
                            </div>
                            <div class="bubble-designer-arrow">›</div>
                        </button>
                    </div>
                </div>
                
                <!-- 预留更多外观设置 -->
                <div class="appearance-section">
                    <h3 class="appearance-section-title">更多设置</h3>
                    <p class="appearance-section-desc">敬请期待更多个性化选项</p>
                    <div class="coming-soon">
                        <div class="coming-soon-icon">🎨</div>
                        <div class="coming-soon-text">更多外观选项即将推出</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="memory-management-page" id="memoryManagementPage">
            <div class="chat-header">
                <div class="back-btn" onclick="showPage('profilePage')">
                    <span>‹</span>
                    <span>返回</span>
                </div>
                <div class="chat-title">记忆管理</div>
                <div class="header-actions">
                    <button class="header-btn" onclick="showAddMemoryModal()">添加</button>
                </div>
            </div>
            
            <div class="memory-management-container">
                <div class="memory-tabs">
                    <button class="memory-tab active" onclick="switchMemoryTab('global')">全局记忆</button>
                    <button class="memory-tab" onclick="switchMemoryTab('character')">角色记忆</button>
                </div>
                
                <div class="memory-content">
                    <div class="memory-section" id="globalMemorySection">
                        <div class="memory-list" id="globalMemoryList">
                            <div class="memory-empty">暂无全局记忆</div>
                        </div>
                    </div>
                    
                    <div class="memory-section hidden" id="characterMemorySection">
                        <div class="character-selector">
                            <select id="characterSelector" onchange="loadCharacterMemories()">
                                <option value="">选择角色...</option>
                            </select>
                        </div>
                        <div class="memory-list" id="characterMemoryList">
                            <div class="memory-empty">请先选择角色</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 个人主页页面 -->
        <div class="user-profile-page" id="userProfilePage">
            <div class="user-profile-header">
                <div class="back-btn" onclick="goBackFromUserProfile()">
                    <span>‹</span>
                    <span>返回</span>
                </div>
                <div class="user-profile-actions">
                    <span class="header-icon">⋯</span>
                </div>
            </div>
            
            <div class="user-profile-content">
                <div class="user-profile-banner" id="userProfileBanner" onclick="openBannerUploadModal()" style="cursor: pointer;" data-umami-event="Banner Click">
                    <div class="banner-upload-hint" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: rgba(255,255,255,0.7); font-size: 14px; pointer-events: none; opacity: 0; transition: opacity 0.3s;">
                        点击更换背景图片
                    </div>
                    <div class="user-profile-avatar-container" onclick="event.stopPropagation()">
                        <div class="user-profile-name" id="userProfileName">我的昵称</div>
                        <div class="user-profile-avatar" id="userProfileAvatar">我</div>
                    </div>
                </div>
                
                <!-- 朋友圈瀑布流 -->
                <div class="user-profile-moments" id="userProfileMoments">
                    <div class="user-profile-moments-empty">
                        <div class="moments-empty-icon">📝</div>
                        <div class="moments-empty-text">还没有朋友圈动态</div>
                    </div>
                    <div class="user-profile-moments-list" id="userProfileMomentsList"></div>
                </div>
            </div>
        </div>

        <!-- API配置管理页面 -->
        <div class="page" id="apiConfigManagementPage" style="display: none;">
            <div class="page-header">
                <div class="back-btn" onclick="showPage('profilePage')">
                    <span>‹</span>
                    <span>返回</span>
                </div>
                <div class="page-title">API配置管理</div>
                <div class="page-actions">
                    <button class="header-btn" onclick="showNewApiConfigForm()">添加</button>
                </div>
            </div>
            <div class="page-content">
                <div class="config-list" id="apiConfigList">
                    <div class="config-list-empty">
                        <div class="empty-icon">⚙️</div>
                        <div class="empty-text">暂无API配置</div>
                        <button class="empty-action-btn" onclick="showNewApiConfigForm()">添加第一个配置</button>
                    </div>
                </div>
                
                <!-- 配置表单 -->
                <div class="config-form" id="apiConfigForm" style="display: none;">
                    <div class="config-form-header">
                        <h3 id="configFormTitle">新增API配置</h3>
                        <button class="close-form-btn" onclick="closeApiConfigForm()">✕</button>
                    </div>
                    
                    <form onsubmit="saveApiConfigInPage(event)" id="apiConfigPageForm">
                        <div class="form-group">
                            <label class="form-label">配置名称</label>
                            <input type="text" class="form-input" id="pageConfigName" required placeholder="给这个配置起个名字">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">API URL</label>
                            <input type="url" class="form-input" id="pageApiUrl" required placeholder="例如: https://api.openai.com/v1">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">API Key</label>
                            <div class="api-key-row">
                                <input type="password" class="form-input api-key-input" id="pageApiKey" required>
                                <div class="timeout-group">
                                    <label class="timeout-label">超时</label>
                                    <input type="number" class="timeout-input" id="pageApiTimeout" min="5" max="300" value="60" placeholder="60">
                                    <span class="timeout-unit">秒</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <button type="button" class="form-submit" onclick="testApiConnectionInPage(event)" style="background-color: #17a2b8; margin-bottom: 10px;">测试连接</button>
                        </div>
                        
                        <div class="form-actions">
                            <button type="button" class="form-button secondary" onclick="closeApiConfigForm()">取消</button>
                            <button type="submit" class="form-button primary">保存配置</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- 新的全屏设置页面 -->
        <div class="contact-settings-page" id="contactSettingsPage">
            <div class="chat-header">
                <div class="back-btn" onclick="closeContactSettingsPage()">
                    <span>‹</span>
                    <span>返回</span>
                </div>
                <div class="chat-title" id="contactSettingsTitle">联系人设置</div>
                <div class="chat-header-spacer"></div>
            </div>
            
            <div class="contact-settings-content">
                <!-- 角色信息设置区 -->
                <div class="settings-section">
                    <div class="settings-section-title">角色信息</div>
                    <div class="settings-item" onclick="showEditContactModal()" data-umami-event="Edit Contact Open">
                        <div class="settings-item-icon">✏️</div>
                        <div class="settings-item-content">
                            <div class="settings-item-label">编辑人设</div>
                            <div class="settings-item-desc">修改角色名称、头像、性格描述等</div>
                        </div>
                        <div class="settings-item-arrow">›</div>
                    </div>
                </div>

                <!-- 聊天设置区 -->
                <div class="settings-section">
                    <div class="settings-section-title">聊天设置</div>
                    <div class="settings-item" onclick="showBackgroundModal()" data-umami-event="Background Settings Open">
                        <div class="settings-item-icon">🎨</div>
                        <div class="settings-item-content">
                            <div class="settings-item-label">设置背景</div>
                            <div class="settings-item-desc">更换聊天背景图片</div>
                        </div>
                        <div class="settings-item-arrow">›</div>
                    </div>
                </div>

                <!-- 数据管理区 -->
                <div class="settings-section">
                    <div class="settings-section-title">数据管理</div>
                    <div class="settings-item" onclick="clearMessages()" data-umami-event="Clear Messages">
                        <div class="settings-item-icon">🗑️</div>
                        <div class="settings-item-content">
                            <div class="settings-item-label">清空聊天</div>
                            <div class="settings-item-desc">删除所有聊天记录，此操作不可撤销</div>
                        </div>
                        <div class="settings-item-arrow">›</div>
                    </div>
                    <div class="settings-item danger-item" onclick="deleteCurrentContact()" data-umami-event="Delete Contact">
                        <div class="settings-item-icon">⚠️</div>
                        <div class="settings-item-content">
                            <div class="settings-item-label">删除联系人</div>
                            <div class="settings-item-desc">永久删除此联系人及所有数据</div>
                        </div>
                        <div class="settings-item-arrow">›</div>
                    </div>
                </div>
            </div>
        </div>


    </div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="showPage('contactListPage')" data-umami-event="Nav Chat">
            <div class="nav-icon">💬</div>
            <div class="nav-text">聊天</div>
        </div>
        <div class="nav-item" onclick="showPage('weiboPage')" data-umami-event="Nav Forum">
            <div class="nav-icon">
                <svg t="1721063385731" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="10099" width="24" height="24"><path d="M822.4 438.4c-3.2-16-16-28.8-32-32-12.8-3.2-25.6-3.2-38.4-3.2-108.8 0-204.8 48-275.2 128-22.4 25.6-41.6 51.2-57.6 80-96-44.8-192-115.2-265.6-204.8-19.2-25.6-48-35.2-76.8-22.4-28.8 12.8-44.8 44.8-35.2 73.6 3.2 9.6 9.6 19.2 16 28.8 48 64 108.8 118.4 179.2 163.2-83.2 16-156.8 64-211.2 131.2-19.2 25.6-16 64 9.6 83.2 25.6 19.2 64 16 83.2-9.6 44.8-54.4 105.6-92.8 172.8-112-6.4 35.2-9.6 70.4-9.6 105.6 0 163.2 102.4 304 249.6 358.4 19.2 6.4 38.4 0 51.2-16 12.8-16 12.8-38.4 0-54.4-115.2-124.8-115.2-300.8 0-425.6 64-70.4 144-112 233.6-121.6 16 0 32-3.2 44.8-9.6 16-9.6 22.4-25.6 19.2-41.6z" fill="#999999" p-id="10100"></path></svg>
            </div>
            <div class="nav-text">论坛</div>
        </div>
        <div class="nav-item" onclick="showPage('momentsPage')" data-umami-event="Nav Discover">
            <div class="nav-icon">🔍</div>
            <div class="nav-text">发现</div>
        </div>
        <div class="nav-item" onclick="showPage('interactivePage')" data-umami-event="Nav Interactive">
            <div class="nav-icon">🎮</div>
            <div class="nav-text">互动</div>
        </div>
        <div class="nav-item" onclick="showPage('profilePage')" data-umami-event="Nav Profile">
            <div class="nav-icon">👤</div>
            <div class="nav-text">我</div>
        </div>
    </div>

    <div class="modal" id="generatePostModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">生成论坛帖子</div>
                <div class="modal-close" onclick="closeModal('generatePostModal')">取消</div>
            </div>
            <div class="modal-body">
                <form onsubmit="handleGeneratePost(event)">
                    <div class="form-group">
                        <label class="form-label">选择角色</label>
                        <select class="form-input" id="postGenCharacterSelect" onchange="handleCharacterChange()" required>
                            <option value="">请选择...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">关系类型</label>
                        <select class="form-input" id="postGenRelations" onchange="handleRelationChange()" required>
                            <option value="">请选择...</option>
                            <option value="CP">CP</option>
                            <option value="CB">CB</option>
                            <option value="好友">好友</option>
                            <option value="宿敌">宿敌</option>
                            <option value="custom">自定义</option>
                        </select>
                    </div>
                    <div class="form-group" style="display: none;">
                        <label class="form-label">自定义关系</label>
                        <input type="text" class="form-input" id="postGenCustomRelation" placeholder="请描述你们的关系">
                    </div>
                    <div class="form-group">
                        <label class="form-label">话题</label>
                        <input type="text" class="form-input" id="postGenHashtag" placeholder="例如：AB、BA、A & B、AB的日记 等" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">生成数量</label>
                        <input type="number" class="form-input" id="postGenCount" value="1" min="1" max="5" required>
                    </div>
                    <button type="submit" class="form-submit" data-umami-event="Generate Forum Post">开始生成</button>
                </form>
            </div>
        </div>
    </div>

    <!-- 朋友圈发布方式选择模态框 -->
    <div class="modal" id="momentChoiceModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">发布朋友圈</div>
                <div class="modal-close" onclick="closeModal('momentChoiceModal')">取消</div>
            </div>
            <div class="modal-body">
                <div class="post-choice-container">
                    <div class="choice-option" onclick="selectMomentType('manual')">
                        <div class="choice-icon">✍️</div>
                        <div class="choice-title">自己发朋友圈</div>
                        <div class="choice-description">手动输入朋友圈内容，系统会生成评论</div>
                    </div>
                    <div class="choice-option" onclick="selectMomentType('generate')">
                        <div class="choice-icon">✨</div>
                        <div class="choice-title">生成朋友圈</div>
                        <div class="choice-description">AI根据聊天记录自动生成朋友圈和评论</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 手动发朋友圈模态框 -->
    <div class="modal" id="manualMomentModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">发布朋友圈</div>
                <div class="modal-close" onclick="closeModal('manualMomentModal')">取消</div>
            </div>
            <div class="modal-body">
                <form onsubmit="handleManualMoment(event)">
                    <div class="form-group">
                        <label class="form-label">发布人</label>
                        <input type="text" class="form-input" id="manualMomentAuthor" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">朋友圈内容</label>
                        <textarea class="form-input" id="manualMomentContent" placeholder="输入你的朋友圈内容..." rows="4" required></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">位置（可选）</label>
                        <input type="text" class="form-input" id="manualMomentLocation" placeholder="输入位置信息...">
                    </div>
                    <div class="form-group">
                        <label class="form-label">上传图片（最多9张）</label>
                        <input type="file" id="momentImagesInput" accept="image/*" multiple style="margin-bottom: 10px;" onchange="handleMomentImagesUpload(event)">
                        <div class="moment-images-preview" id="momentImagesPreview"></div>
                    </div>
                    <button type="submit" class="form-submit" data-umami-event="Manual Moment Submit">发布并生成评论</button>
                </form>
            </div>
        </div>
    </div>

    <!-- AI生成朋友圈模态框 -->
    <div class="modal" id="generateMomentModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">生成朋友圈</div>
                <div class="modal-close" onclick="closeModal('generateMomentModal')">取消</div>
            </div>
            <div class="modal-body">
                <form onsubmit="handleGenerateMoment(event)">
                    <div class="form-group">
                        <label class="form-label">选择角色</label>
                        <select class="form-input" id="momentGenCharacterSelect" required>
                            <option value="">请选择...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">朋友圈主题</label>
                        <input type="text" class="form-input" id="momentGenTopic" placeholder="例如：日常生活、工作感悟、美食分享等（可选）">
                    </div>
                    <div class="form-group">
                        <label class="form-label">位置（可选）</label>
                        <input type="text" class="form-input" id="momentGenLocation" placeholder="输入位置信息，留空则AI自动生成">
                    </div>
                    <button type="submit" class="form-submit" data-umami-event="Generate Moment Submit">生成朋友圈</button>
                </form>
            </div>
        </div>
    </div>

    <!-- 编辑位置模态框 -->
    <div class="modal" id="editLocationModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">修改位置</div>
                <div class="modal-close" onclick="closeModal('editLocationModal')">取消</div>
            </div>
            <div class="modal-body">
                <form onsubmit="handleEditLocation(event)">
                    <div class="form-group">
                        <label class="form-label">位置信息</label>
                        <input type="text" class="form-input" id="editLocationInput" placeholder="输入位置信息，留空则不显示位置">
                        <input type="hidden" id="editLocationMomentId">
                    </div>
                    <button type="submit" class="form-submit">保存</button>
                </form>
            </div>
        </div>
    </div>

    <div class="modal" id="addContactModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="contactModalTitle">添加角色</div>
                <div class="modal-close" onclick="closeModal('addContactModal')">取消</div>
            </div>
            <div class="modal-body">
                <form onsubmit="saveContact(event)">
                    <div class="form-group">
                        <label class="form-label">角色名称</label>
                        <input type="text" class="form-input" id="contactName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">头像（可选）</label>
                        <input type="url" class="form-input" id="contactAvatar" placeholder="可直接粘贴URL或上传本地图片">
                        <div style="display: flex; align-items: center; gap: 10px; margin-top: 8px;">
                            <input type="file" id="avatarUploadInput" accept="image/*" style="flex: 1;" onchange="handleContactAvatarUpload(event, window.editingContact)">
                            <span id="avatarUploadStatus" style="font-size: 12px; color: #07c160;"></span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">人设描述</label>
                        <textarea class="form-textarea" id="contactPersonality" required placeholder="描述AI的性格、背景、说话风格等"></textarea>
                    </div>
                    
                    <!-- 【修改点 2】: 更新联系人设置中的语音ID提示 -->
                    <div class="form-group">
                        <label class="form-label">Minimax 语音ID（可选）</label>
                        <input type="text" class="form-input" id="contactVoiceId" placeholder="可选 - 填写后角色会拥有语音能力">
                        <div class="context-info" style="margin-top: 4px;">
                            在 <a href="https://www.minimaxi.com/voice-clone" target="_blank" rel="noopener noreferrer">Minimax官网</a> 克隆或创建声音！
                        </div>
                    </div>
                    
                    <div class="prompt-section">
                        <div class="prompt-header">
                            <div class="prompt-title">自定义提示词（可选）</div>
                            <div class="prompt-actions">
                                <button type="button" class="prompt-btn" onclick="document.getElementById('promptFile').click()">导入JSON</button>
                                <input type="file" id="promptFile" class="file-input" accept=".json" onchange="importPrompts(event)">
                            </div>
                        </div>
                        <div class="form-group">
                            <textarea class="form-textarea" id="customPrompts" placeholder="输入自定义提示词，或导入JSON文件"></textarea>
                        </div>
                    </div>
                    
                    <button type="submit" class="form-submit">确定</button>
                </form>
            </div>
        </div>
    </div>

    <div class="modal" id="createGroupModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">创建群聊</div>
                <div class="modal-close" onclick="closeModal('createGroupModal')">取消</div>
            </div>
            <div class="modal-body">
                <form onsubmit="createGroup(event)">
                    <div class="form-group">
                        <label class="form-label">群聊名称</label>
                        <input type="text" class="form-input" id="groupName" required>
                    </div>
                    
                    <div class="create-group-section">
                        <label class="form-label">选择群成员</label>
                        <div class="group-member-list" id="groupMemberList"></div>
                    </div>
                    
                    <button type="submit" class="form-submit">创建群聊</button>
                </form>
            </div>
        </div>
    </div>

    <div class="modal" id="editProfileModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">编辑个人信息</div>
                <div class="modal-close" onclick="closeModal('editProfileModal')">取消</div>
            </div>
            <div class="modal-body">
                <form onsubmit="saveProfile(event)">
                    <div class="form-group">
                        <label class="form-label">昵称</label>
                        <input type="text" class="form-input" id="profileNameInput" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">头像（可选）</label>
                        <input type="url" class="form-input" id="profileAvatarInput" placeholder="可直接粘贴URL或上传本地图片">
                         <div style="display: flex; align-items: center; gap: 10px; margin-top: 8px;">
                            <input type="file" id="profileUploadInput" accept="image/*" style="flex: 1;" onchange="handleProfileAvatarUpload(event)">
                            <span id="profileUploadStatus" style="font-size: 12px; color: #07c160;"></span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">我的人设描述</label>
                        <textarea class="form-textarea" id="profilePersonality" placeholder="描述你的性格、背景、说话风格等，让AI更好地与你互动"></textarea>
                    </div>
                    <button type="submit" class="form-submit">保存</button>
                </form>
            </div>
        </div>
    </div>

    <div class="modal" id="apiSettingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">API配置管理</div>
                <div class="modal-close" onclick="closeModal('apiSettingsModal')">取消</div>
            </div>
            <div class="modal-body">
                <!-- 配置选择和管理区域 -->
                <div class="config-management-section">
                    <div class="config-selector-row">
                        <div class="config-selector-group">
                            <label class="form-label">当前配置</label>
                            <select class="form-input" id="configSelector" onchange="handleConfigSwitch(this.value)">
                                <option value="">加载中...</option>
                            </select>
                        </div>
                        <div class="config-actions">
                            <button type="button" class="config-action-btn" onclick="showNewConfigForm()" title="新增配置">➕</button>
                            <button type="button" class="config-action-btn config-delete-btn" onclick="deleteCurrentConfig()" title="删除配置" id="deleteBtn">🗑️</button>
                        </div>
                    </div>
                </div>
                
                <!-- API配置表单 -->
                <form onsubmit="saveApiConfig(event)" id="apiConfigForm">
                    <div class="form-group">
                        <label class="form-label">配置名称</label>
                        <input type="text" class="form-input" id="configName" required placeholder="给这个配置起个名字">
                    </div>
                    
                    <div class="config-section">
                        <div class="config-section-title">API配置</div>
                        <div class="form-group">
                            <label class="form-label">API URL</label>
                            <input type="url" class="form-input" id="apiUrl" required placeholder="例如: https://api.openai.com/v1">
                        </div>
                        <div class="form-group main-api-key-group">
                            <label class="form-label">API Key (主Key)</label>
                            <div class="compact-key-row main-key-row">
                                <input type="password" class="form-input api-key-input compact-key-input" id="apiKey" required oninput="updateMainKeyStats(this); handleApiKeyInput(this, event)" placeholder="输入主API Key">
                                <div class="timeout-group">
                                    <input type="number" class="timeout-input" id="apiTimeout" min="5" max="300" value="60" placeholder="60" title="超时(秒)">
                                    <span class="timeout-unit">s</span>
                                </div>
                                <button type="button" class="key-status-btn main-key-status" data-status="enabled" data-enabled="true" onclick="toggleMainKeyStatus(this)" title="主Key(已启用)">🟢</button>
                                <div class="key-stats-compact">
                                    <div class="key-masked-compact" id="mainKeyMask">未设置</div>
                                    <div class="stats-compact">
                                        <span id="mainKeyCalls">0次</span>/<span id="mainKeySuccess">0%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <button type="button" class="form-submit" onclick="addProviderRow()" style="background-color: #28a745; margin-bottom: 10px; font-size: 14px; padding: 8px 16px;">
                                ➕ 添加API Key
                            </button>
                            <div class="context-info" style="margin-top: -5px; font-size: 12px; color: #666;">
                                可以添加多个API Key，手动选择启用的Key
                            </div>
                        </div>
                        
                        <button type="button" class="form-submit" onclick="enhancedTestApiConnection()" style="margin-bottom: 10px;" data-umami-event="Test API Connection">测试连接</button>
                    </div>
                    
                    <button type="submit" class="form-submit" data-umami-event="Save API Config">保存API配置 <small>(第1步)</small></button>
                    <div class="form-step-hint" id="configSaveHint">
                        ✅ API配置已保存！接下来：<strong>①选择配置 ②选择模型 ③滑到最后点击"完成设置"</strong>
                    </div>
                </form>
                
                <!-- 模型和功能配置 -->
                <form onsubmit="saveAppSettings(event)" id="appSettingsForm" style="margin-top: 20px;">
                    <div class="config-section">
                        <div class="config-section-title">应用设置</div>
                        
                        <div class="context-control">
                            <div class="context-header">
                                <div class="context-title">上下文长度</div>
                                <div class="context-value" id="contextValue">10条</div>
                            </div>
                            <input 
                                type="range" 
                                class="context-slider" 
                                id="contextSlider" 
                                min="1" 
                                max="50" 
                                value="10"
                                oninput="updateContextValue(this.value)"
                            >
                            <div class="context-info">
                                控制AI可见的历史消息数量，较长的上下文有助于保持对话连贯性，但可能会增加API成本。
                            </div>
                        </div>
                        
                        <div class="config-section">
                            <div class="config-section-title">模型选择</div>
                            <div class="form-step-reminder" id="modelSelectionReminder">
                                💡 <strong>操作流程：</strong>①保存上方API配置 → ②选择API配置 → ③选择模型 → ④滑到最后点击"完成设置"
                            </div>
                        
                        <div class="form-group">
                            <label class="form-label">主要模型</label>
                            <div class="model-selection-row">
                                <select class="form-input model-config-select" id="primaryConfigSelect" onchange="loadModelsForConfig('primaryConfigSelect', 'primaryModelSelect')">
                                    <option value="">选择API配置</option>
                                </select>
                                <select class="form-input model-select" id="primaryModelSelect" onchange="saveModelSelection('primary')">
                                    <option value="">请先完成第1步保存API配置</option>
                                </select>
                            </div>
                            <div class="context-info" style="margin-top: 4px;">生成对话、生成帖子等使用的模型。建议选择质量高的模型。</div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">次要模型</label>
                            <div class="model-selection-row">
                                <select class="form-input model-config-select" id="secondaryConfigSelect" onchange="loadModelsForConfig('secondaryConfigSelect', 'secondaryModelSelect')">
                                    <option value="">选择API配置</option>
                                    <option value="sync_with_primary">与主模型保持一致</option>
                                </select>
                                <select class="form-input model-select" id="secondaryModelSelect" onchange="saveModelSelection('secondary')">
                                    <option value="">请先完成第1步保存API配置</option>
                                    <option value="sync_with_primary">与主模型保持一致</option>
                                </select>
                            </div>
                            <div class="context-info" style="margin-top: 4px;">用于总结、填写记忆表格等，建议选择便宜的模型，以节约成本。若不介意成本，可选择与主要模型保持一致。</div>
                        </div>
                        </div>
                    
                    <div class="config-section">
                        <div class="config-section-title">扩展功能</div>
                        <div class="form-group">
                            <label for="minimaxGroupId" class="form-label">Minimax Group ID</label>
                            <input type="text" id="minimaxGroupId" class="form-input" placeholder="输入你的 Minimax Group ID...">
                        </div>
                        <div class="form-group">
                            <label for="minimaxApiKey" class="form-label">Minimax API Key (for TTS)</label>
                            <input type="password" id="minimaxApiKey" class="form-input" placeholder="输入你的 Minimax API Key...">
                            <div class="context-info" style="margin-top: 4px;">
                                用于语音克隆功能。在 <a href="https://www.minimaxi.com/" target="_blank" rel="noopener noreferrer">Minimax官网</a> 获取凭证。
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="unsplashApiKey" class="form-label">Unsplash API Key（可选）</label>
                            <input type="password" id="unsplashApiKey" class="form-input" placeholder="输入你的 Unsplash Access Key...">
                            <div class="context-info" style="margin-top: 4px;">
                                用于为论坛帖子和朋友圈自动配图。在 <a href="https://unsplash.com/developers" target="_blank" rel="noopener noreferrer">Unsplash Developers</a> 获取API Key。
                            </div>
                        </div>
                        </div>
                    </div>

                    <div class="final-step-hint">
                        🎯 <strong>最后一步：</strong>确认已选择配置和模型后，点击下方按钮完成设置！
                    </div>
                    <button type="submit" class="form-submit" data-umami-event="Save App Settings">完成设置 <small>(第2步)</small></button>
                </form>
            </div>
        </div>
    </div>

    <div class="modal" id="backgroundModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">设置聊天背景</div>
                <div class="modal-close" onclick="closeModal('backgroundModal')">取消</div>
            </div>
            <div class="modal-body">
                <form onsubmit="setBackground(event)">
                    <div class="form-group">
                        <label class="form-label">背景图片</label>
                        <input type="url" class="form-input" id="backgroundUrl" placeholder="可直接粘贴URL或上传本地图片">
                        <div style="display: flex; align-items: center; gap: 10px; margin-top: 8px;">
                            <input type="file" id="bgUploadInput" accept="image/*" style="flex: 1;" onchange="window.ImageUploadHandlers.handleBgUpload(event)">
                            <span id="bgUploadStatus" style="font-size: 12px; color: #07c160;"></span>
                        </div>
                    </div>
                    <button type="submit" class="form-submit" data-umami-event="Contact Background Save">确定</button>
                </form>
            </div>
        </div>
    </div>

    <div class="modal" id="addEmojiModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">添加表情包</div>
                <div class="modal-close" onclick="closeModal('addEmojiModal')">取消</div>
            </div>
            <div class="modal-body">
                <form onsubmit="addEmoji(event)">
                    <div class="form-group">
                        <label class="form-label">表情图片</label>
                        <input type="url" class="form-input" id="emojiUrl" placeholder="可直接粘贴URL或上传本地图片" required>
                        <div style="display: flex; align-items: center; gap: 10px; margin-top: 8px;">
                            <input type="file" id="emojiUploadInput" accept="image/*" style="flex: 1;" onchange="window.ImageUploadHandlers.handleEmojiFileUpload(event)">
                            <span id="emojiUploadStatus" style="font-size: 12px; color: #07c160;"></span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">表情含义（用于AI理解和调用）</label>
                        <input type="text" class="form-input" id="emojiMeaning" required placeholder="例如：开心、大笑、哭泣等">
                    </div>
                    <button type="submit" class="form-submit" data-umami-event="Sticker Save">添加</button>
                </form>
            </div>
        </div>
    </div>
    
    <div class="modal" id="redPacketModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">发红包</div>
                <div class="modal-close" onclick="closeModal('redPacketModal')">取消</div>
            </div>
            <div class="modal-body">
                <form onsubmit="sendRedPacket(event)">
                    <div class="form-group">
                        <label class="form-label">金额</label>
                        <input type="number" class="form-input" id="redPacketAmount" step="0.01" required placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label class="form-label">留言（可选）</label>
                        <input type="text" class="form-input" id="redPacketMessage" placeholder="恭喜发财，大吉大利！">
                    </div>
                    <button type="submit" class="form-submit" data-umami-event="Redpacket Send">塞钱进红包</button>
                </form>
            </div>
        </div>
    </div>

    <div id="musicModal" class="music-modal">
        <div class="music-modal-content">
            <span class="close-btn" id="closeMusicModal">&times;</span>
            <h2>🎵 音乐播放器</h2>
            
            <div id="currentSongInfo" style="display: none;">
                <h3>正在播放: <span id="currentSongName"></span></h3>
                <div class="player-controls">
                    <div class="progress-bar" id="progressBar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="time-display">
                        <span id="currentTime">0:00</span>
                        <span id="totalTime">0:00</span>
                    </div>
                    <div style="text-align: center; margin-top: 10px;">
                        <button class="form-submit" onclick="togglePlay()">
                            <span id="playPauseBtn">▶️ 播放</span>
                        </button>
                        <button class="form-submit" style="background-color: #888;" onclick="stopMusic()">⏹️ 停止</button>
                    </div>
                </div>
            </div>

            <h3>我的歌单</h3>
            <div class="playlist-container" id="playlistContainer">
                <p style="text-align: center; color: #999;">暂无歌曲</p>
            </div>

            <h3>添加新歌曲</h3>
            <div id="addSongForm">
                <div class="form-group">
                    <label class="form-label">歌曲名称 (可选):</label>
                    <input type="text" class="form-input" id="songName" placeholder="留空则使用文件名">
                </div>
                <div class="form-group">
                    <label class="form-label">选择音乐文件:</label>
                    <input type="file" class="form-input" id="musicFileUpload" accept="audio/*,.mp3,.m4a,.wav,.flac">
                </div>
                <div class="form-group">
                    <label class="form-label">LRC歌词文件 (可选):</label>
                    <input type="file" class="form-input" id="lrcFile" accept=".lrc">
                    <small style="color: #666;">请选择.lrc格式的歌词文件</small>
                </div>
                <button class="form-submit" onclick="saveSong()">保存歌曲</button>
            </div>

            <div style="margin-top: 20px;">
                <label>
                    <input type="checkbox" id="showLyrics" onchange="toggleLyricsDisplay()">
                    显示浮动歌词
                </label>
            </div>
        </div>
    </div>

    <div id="floatingLyrics" class="floating-lyrics" style="display: none;">
        <span id="currentLyric">等待歌词...</span>
    </div>

    <div class="toast" id="toast"></div>
    
    <div class="top-notification" id="topNotification"></div>

    <!-- Update Announcement Modal -->
    <div class="modal" id="updateModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">更新公告</div>
            </div>
            <div class="modal-body" id="updateModalBody">
                <!-- Content will be injected by JS to handle markdown -->
            </div>
            <div class="modal-footer">
                 <button class="form-submit" id="updateModalCloseBtn">我知道了</button>
            </div>
        </div>
    </div>

    <!-- Post Choice Modal -->
    <div class="modal" id="postChoiceModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">创建论坛帖子</div>
                <div class="modal-close" onclick="closeModal('postChoiceModal')">取消</div>
            </div>
            <div class="modal-body">
                <div class="post-choice-container">
                    <div class="choice-option" onclick="selectPostType('manual')">
                        <div class="choice-icon">✍️</div>
                        <div class="choice-title">自己发帖子</div>
                        <div class="choice-description">手动输入帖子内容，系统会生成评论</div>
                    </div>
                    <div class="choice-option" onclick="selectPostType('generate')">
                        <div class="choice-icon">✨</div>
                        <div class="choice-title">生成帖子</div>
                        <div class="choice-description">AI根据聊天记录自动生成帖子和评论</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Manual Post Modal -->
    <div class="modal" id="manualPostModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">发布帖子</div>
                <div class="modal-close" onclick="closeModal('manualPostModal')">取消</div>
            </div>
            <div class="modal-body">
                <form onsubmit="handleManualPost(event)">
                    <div class="form-group">
                        <label class="form-label">发帖人</label>
                        <input type="text" class="form-input" id="manualPostAuthor" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">话题标签</label>
                        <input type="text" class="form-input" id="manualPostTag" value="碎碎念" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">帖子内容</label>
                        <textarea class="form-input" id="manualPostContent" placeholder="输入你的帖子内容..." rows="4" required></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">图片描述</label>
                        <textarea class="form-input" id="manualPostImageDesc" placeholder="描述配图内容（可选）..." rows="2"></textarea>
                    </div>
                    <button type="submit" class="form-submit" data-umami-event="Manual Forum Post Submit">发布并生成评论</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Memory Modal -->
    <div class="modal" id="addMemoryModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">添加记忆</div>
                <div class="modal-close" onclick="closeModal('addMemoryModal')">取消</div>
            </div>
            <div class="modal-body">
                <form onsubmit="handleAddMemory(event)">
                    <div class="form-group" id="memoryTypeGroup">
                        <label class="form-label">记忆类型</label>
                        <select class="form-input" id="memoryType" onchange="handleMemoryTypeChange()">
                            <option value="global">全局记忆</option>
                            <option value="character">角色记忆</option>
                        </select>
                    </div>
                    <div class="form-group hidden" id="characterSelectGroup">
                        <label class="form-label">选择角色</label>
                        <select class="form-input" id="memoryCharacterSelect">
                            <option value="">选择角色...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">记忆内容</label>
                        <textarea class="form-input" id="memoryContent" placeholder="填写你想让AI记住的内容，一行为一条新记忆" rows="6" required></textarea>
                        <div class="form-hint">每行为一条记忆，系统会自动格式化。</div>
                    </div>
                    <button type="submit" class="form-submit" data-umami-event="Memory Add Confirm">添加记忆</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Memory Modal -->
    <div class="modal" id="editMemoryModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">编辑记忆</div>
                <div class="modal-close" onclick="closeModal('editMemoryModal')">取消</div>
            </div>
            <div class="modal-body">
                <form onsubmit="handleEditMemory(event)">
                    <div class="form-group">
                        <label class="form-label">记忆内容</label>
                        <textarea class="form-input" id="editMemoryContent" placeholder="请使用以下格式：&#10;- 第一条记忆&#10;- 第二条记忆&#10;- 第三条记忆" rows="6" required></textarea>
                        <div class="form-hint">只支持 "- 记忆内容" 格式，一行一条记忆。其他格式会被自动忽略。</div>
                    </div>
                    <button type="submit" class="form-submit">保存修改</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Single Memory Item Modal -->
    <div class="modal" id="editSingleMemoryModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">编辑记忆项</div>
                <div class="modal-close" onclick="closeModal('editSingleMemoryModal')">取消</div>
            </div>
            <div class="modal-body">
                <form onsubmit="handleEditSingleMemory(event)">
                    <div class="form-group">
                        <label class="form-label">记忆内容</label>
                        <textarea class="form-input" id="editSingleMemoryContent" placeholder="填写你想让AI记住的内容" rows="4" required></textarea>
                        <div class="form-hint">编辑单条记忆的内容。</div>
                    </div>
                    <button type="submit" class="form-submit" data-umami-event="Memory Edit Save">保存修改</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Banner上传模态框 -->
    <div class="modal" id="bannerUploadModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">更换背景图片</div>
                <div class="modal-close" onclick="closeModal('bannerUploadModal')">取消</div>
            </div>
            <div class="modal-body">
                <div class="banner-upload-container">
                    <div class="banner-upload-area" id="bannerUploadArea" onclick="triggerBannerFileInput()">
                        <div class="banner-upload-icon">📷</div>
                        <div class="banner-upload-text">点击选择图片</div>
                        <div class="banner-upload-hint">支持 JPG、PNG 格式，推荐横图</div>
                    </div>
                    <input type="file" id="bannerFileInput" accept="image/jpeg,image/jpg,image/png" style="display: none;" onchange="handleBannerFileSelect(event)">
                </div>
                
                <!-- 预览和裁剪区域 -->
                <div class="banner-preview-container" id="bannerPreviewContainer" style="display: none;">
                    <div class="banner-preview-title">预览效果</div>
                    <div class="banner-preview-wrapper">
                        <canvas id="bannerPreviewCanvas" width="400" height="160"></canvas>
                    </div>
                    <div class="banner-crop-controls">
                        <label>垂直位置调整：</label>
                        <input type="range" id="bannerCropSlider" min="0" max="100" value="50" oninput="updateBannerPreview()">
                    </div>
                    <div class="banner-upload-buttons">
                        <button class="btn-secondary" onclick="resetBannerUpload()">重新选择</button>
                        <button class="btn-primary" onclick="saveBannerImage()" data-umami-event="Banner Upload Save">应用背景</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 七夕节AI空回复重试模态框 -->
    <div class="modal" id="qixiRetryModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">🌟 请求失败</div>
                <div class="modal-close" onclick="closeModal('qixiRetryModal')">✕</div>
            </div>
            <div class="modal-body">
                <div class="qixi-retry-content">
                    <div class="qixi-retry-icon">❤️‍🩹</div>
                    <div class="qixi-retry-message">
                        <p><strong>操作失败</strong></p>
                        <p>是否要重新尝试？</p>
                    </div>
                </div>
                <div class="qixi-retry-buttons">
                    <button type="button" class="form-button qixi-retry-btn" onclick="handleQixiRetry()">
                        重新尝试
                    </button>
                    <button type="button" class="form-button qixi-cancel-btn" onclick="closeModal('qixiRetryModal')">
                        取消
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 清空localStorage确认对话框 -->
    <div class="modal" id="clearLocalStorageModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">⚠️ 危险操作确认</div>
                <div class="modal-close" onclick="closeModal('clearLocalStorageModal')">✕</div>
            </div>
            <div class="modal-body">
                <div style="text-align: center; padding: 20px;">
                    <div style="font-size: 48px; margin-bottom: 16px;">🗑️</div>
                    <div style="margin-bottom: 20px;">
                        <p style="font-size: 16px; font-weight: bold; color: #dc3545; margin-bottom: 10px;">
                            你即将清空所有localStorage！
                        </p>
                        <p style="font-size: 14px; color: #666; margin-bottom: 8px;">
                            这可能会导致意外的逻辑触发
                        </p>
                        <p style="font-size: 14px; color: #dc3545; font-weight: 600;">
                            除非你知道你在做什么，否则不要确认！
                        </p>
                    </div>
                    <div style="display: flex; gap: 12px;">
                        <button data-umami-event="Confirm Clear localStorage" type="button" class="form-button" onclick="executeLocalStorageClear()" 
                                style="flex: 1; background: #dc3545; color: white; border: none; padding: 12px; border-radius: 6px; font-size: 14px; cursor: pointer;">
                            确认
                        </button>
                        <button type="button" class="form-button" onclick="closeModal('clearLocalStorageModal')" 
                                style="flex: 1; background: #6c757d; color: white; border: none; padding: 12px; border-radius: 6px; font-size: 14px; cursor: pointer;">
                            取消
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- API模型加载等待提示框 -->
    <div class="modal" id="apiLoadingModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">正在加载模型信息</div>
                <div class="modal-close" onclick="cancelApiLoading()">取消</div>
            </div>
            <div class="modal-body">
                <div style="text-align: center; padding: 20px;">
                    <div style="font-size: 48px; margin-bottom: 16px;">⏳</div>
                    <div style="margin-bottom: 20px;">
                        <p style="font-size: 16px; margin-bottom: 10px;">
                            正在获取模型列表...
                        </p>
                        <p style="font-size: 14px; margin-bottom: 6px;">
                            此过程取决于您的网速和存储配置的数量。若等待时间过长，建议更换网络重试。
                        </p>
                        <p style="font-size: 24px; font-weight: bold; color: var(--theme-primary);" id="loadingCountdown">
                            0s
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/marked@4.3.0/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <!-- 🔥 统一数据库管理器 - 替代所有数据库相关模块 -->
    <script src="utils/UnifiedDBManager.js"></script>
    
    <!-- 应用核心模块 -->
    <script src="utils/uiManager.js"></script>
    <script src="js/api.js"></script>
    <script src="utils/colorUtils.js"></script>
    <script src="utils/uiUtils.js"></script>
    <script src="utils/formatUtils.js"></script>
    <script src="script.js?v=1.3"></script>
    <script src="utils/promptBuilder.js?v=1.1"></script>
    <script src="utils/memoryTable.js?v=1.1"></script>
    
    <!-- 图片和文件处理模块 -->
    <script src="utils/imageStorageAPI.js"></script>
    <script src="utils/imageDisplayHelper.js"></script>
    <script src="utils/imageMigrationManager.js"></script>
    <script src="utils/chatEmojiMigrationManager.js"></script>
    <script src="utils/voiceStorageAPI.js"></script>
    <script src="utils/fileStorageExporter.js"></script>
    <script src="utils/fileStorageImporter.js"></script>
    
    <!-- 工具模块 -->
    <script src="utils/systemUtilities.js"></script>
    <script src="utils/characterMemory.js"></script>
    <script src="utils/imageKeywordGenerator.js"></script>
    
    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(function(registration) {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(function(err) {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }
    </script>
    
    <!-- 持久化存储说明模态框 -->
    <div id="persistentStorageInfoModal" class="info-modal modal-overlay hidden" onclick="if(event.target === this) StorageManager.closePersistentStorageInfo()">
        <div class="modal-content">
            <div class="modal-header">
                📚 数据持久化存储说明
            </div>
            <div class="modal-body">
                <p><strong>什么是数据持久化存储？</strong></p>
                <p>数据持久化存储，代表数据不会轻易被设备/浏览器清除。</p>
                
                <p><strong>为什么需要？</strong></p>
                <p>若未持久存储，则可能会被随时清理，导致数据丢失。</p>
                
                <p><strong>如何获得？</strong></p>
                <p>请尝试"申请持久化数据库"按钮。若申请未通过，可以尝试：</p>
                <ul>
                    <li>多访问网页，增加使用频率</li>
                    <li>等几天再尝试申请</li>
                    <li>将网站添加到书签</li>
                </ul>
                
                <p><strong>期间建议</strong></p>
                <p>申请期间，请频繁备份数据以防丢失。</p>
            </div>
            <div class="modal-footer">
                <button class="modal-close-btn" onclick="StorageManager.closePersistentStorageInfo()">
                    我知道了
                </button>
            </div>
        </div>
    </div>
</body>
</html>
